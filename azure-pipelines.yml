trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  phpVersion: 8.1

jobs:
- job: Michael_Sutjiato_Tests
  displayName: "Michael Sutjiato's Tests"
  steps:
  - script: |
      sudo update-alternatives --set php /usr/bin/php$(phpVersion)
      sudo update-alternatives --set phar /usr/bin/phar$(phpVersion)
      sudo update-alternatives --set phpdbg /usr/bin/phpdbg$(phpVersion)
      sudo update-alternatives --set php-cgi /usr/bin/php-cgi$(phpVersion)
      sudo update-alternatives --set phar.phar /usr/bin/phar.phar$(phpVersion)
      php -version
    displayName: 'Use PHP version $(phpVersion)'

  - script: composer install --no-interaction --prefer-dist
    displayName: 'Install Composer dependencies'

  - script: |
      # Create dummy config files to prevent init.php from failing
      mkdir -p config
      echo "<?php define('SITE_URL', 'http://localhost'); ?>" > config/config.php
      echo "<?php class Database { public function __construct() {} public function connect() { return \$this; } public function beginTransaction() {} public function rollBack() {} public function fetchAll(\$sql, \$params = []) { return []; } public function fetch(\$sql, \$params = []) { return null; } public function query(\$sql, \$params = []) {} public function lastInsertId() { return 1; } public function createDatabaseIfNotExists() {} } ?>" > config/database.php
    displayName: 'Create dummy config files'

  - script: |
      echo "Running tests for Michael Sutjiato..."
      ./vendor/bin/phpunit --testsuite "Michael_Sutjiato_Tests" --log-junit "junit-michael.xml" --coverage-text --colors=never
    displayName: "Run Michael Sutjiato's Tests"
    continueOnError: true

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'junit-michael.xml'
      testRunTitle: "Michael Sutjiato's Test Results"
      failTaskOnFailedTests: false
    condition: succeededOrFailed()

- job: Jiaming_Huang_Tests
  displayName: "Jiaming Huang's Tests"
  steps:
  - script: |
      sudo update-alternatives --set php /usr/bin/php$(phpVersion)
      sudo update-alternatives --set phar /usr/bin/phar$(phpVersion)
      sudo update-alternatives --set phpdbg /usr/bin/phpdbg$(phpVersion)
      sudo update-alternatives --set php-cgi /usr/bin/php-cgi$(phpVersion)
      sudo update-alternatives --set phar.phar /usr/bin/phar.phar$(phpVersion)
      php -version
    displayName: 'Use PHP version $(phpVersion)'

  - script: composer install --no-interaction --prefer-dist
    displayName: 'Install Composer dependencies'

  - script: |
      # Create dummy config files to prevent init.php from failing
      mkdir -p config
      echo "<?php define('SITE_URL', 'http://localhost'); ?>" > config/config.php
      echo "<?php class Database { public function __construct() {} public function connect() { return \$this; } public function beginTransaction() {} public function rollBack() {} public function fetchAll(\$sql, \$params = []) { return []; } public function fetch(\$sql, \$params = []) { return null; } public function query(\$sql, \$params = []) {} public function lastInsertId() { return 1; } public function createDatabaseIfNotExists() {} } ?>" > config/database.php
    displayName: 'Create dummy config files'

  - script: |
      echo "Running tests for Jiaming Huang..."
      ./vendor/bin/phpunit --testsuite "Jiaming_Huang_Tests" --log-junit "junit-jiaming.xml" --coverage-text --colors=never
    displayName: "Run Jiaming Huang's Tests"
    continueOnError: true

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'junit-jiaming.xml'
      testRunTitle: "Jiaming Huang's Test Results"
      failTaskOnFailedTests: false
    condition: succeededOrFailed()

- job: Charlotte_Pham_Tests
  displayName: "Charlotte Pham's Tests"
  steps:
  - script: |
      sudo update-alternatives --set php /usr/bin/php$(phpVersion)
      sudo update-alternatives --set phar /usr/bin/phar$(phpVersion)
      sudo update-alternatives --set phpdbg /usr/bin/phpdbg$(phpVersion)
      sudo update-alternatives --set php-cgi /usr/bin/php-cgi$(phpVersion)
      sudo update-alternatives --set phar.phar /usr/bin/phar.phar$(phpVersion)
      php -version
    displayName: 'Use PHP version $(phpVersion)'

  - script: composer install --no-interaction --prefer-dist
    displayName: 'Install Composer dependencies'

  - script: |
      # Create dummy config files to prevent init.php from failing
      mkdir -p config
      echo "<?php define('SITE_URL', 'http://localhost'); ?>" > config/config.php
      echo "<?php class Database { public function __construct() {} public function connect() { return \$this; } public function beginTransaction() {} public function rollBack() {} public function fetchAll(\$sql, \$params = []) { return []; } public function fetch(\$sql, \$params = []) { return null; } public function query(\$sql, \$params = []) {} public function lastInsertId() { return 1; } public function createDatabaseIfNotExists() {} } ?>" > config/database.php
    displayName: 'Create dummy config files'

  - script: |
      echo "Running tests for Charlotte Pham..."
      ./vendor/bin/phpunit --testsuite "Charlotte_Pham_Tests" --log-junit "junit-charlotte.xml" --coverage-text --colors=never
    displayName: "Run Charlotte Pham's Tests"
    continueOnError: true

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'junit-charlotte.xml'
      testRunTitle: "Charlotte Pham's Test Results"
      failTaskOnFailedTests: false
    condition: succeededOrFailed()

- job: Thea_Ngo_Tests
  displayName: "Thea Ngo's Tests"
  steps:
  - script: |
      sudo update-alternatives --set php /usr/bin/php$(phpVersion)
      sudo update-alternatives --set phar /usr/bin/phar$(phpVersion)
      sudo update-alternatives --set phpdbg /usr/bin/phpdbg$(phpVersion)
      sudo update-alternatives --set php-cgi /usr/bin/php-cgi$(phpVersion)
      sudo update-alternatives --set phar.phar /usr/bin/phar.phar$(phpVersion)
      php -version
    displayName: 'Use PHP version $(phpVersion)'

  - script: composer install --no-interaction --prefer-dist
    displayName: 'Install Composer dependencies'

  - script: |
      # Create dummy config files to prevent init.php from failing
      mkdir -p config
      echo "<?php define('SITE_URL', 'http://localhost'); ?>" > config/config.php
      echo "<?php class Database { public function __construct() {} public function connect() { return \$this; } public function beginTransaction() {} public function rollBack() {} public function fetchAll(\$sql, \$params = []) { return []; } public function fetch(\$sql, \$params = []) { return null; } public function query(\$sql, \$params = []) {} public function lastInsertId() { return 1; } public function createDatabaseIfNotExists() {} } ?>" > config/database.php
    displayName: 'Create dummy config files'

  - script: |
      echo "Running tests for Thea Ngo..."
      ./vendor/bin/phpunit --testsuite "Thea_Ngo_Tests" --log-junit "junit-thea.xml" --coverage-text --colors=never
    displayName: "Run Thea Ngo's Tests"
    continueOnError: true

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: 'junit-thea.xml'
      testRunTitle: "Thea Ngo's Test Results"
      failTaskOnFailedTests: false
    condition: succeededOrFailed()